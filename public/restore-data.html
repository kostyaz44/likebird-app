<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üê¶ LikeBird ‚Äî –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, sans-serif; background: linear-gradient(135deg, #fbbf24, #f97316); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
  .card { background: white; border-radius: 24px; padding: 32px; max-width: 480px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
  h1 { font-size: 24px; font-weight: 900; margin-bottom: 8px; }
  .sub { color: #6b7280; font-size: 14px; margin-bottom: 24px; line-height: 1.5; }
  .btn { width: 100%; padding: 16px; border: none; border-radius: 16px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s; margin-bottom: 12px; }
  .btn-primary { background: linear-gradient(135deg, #f59e0b, #ef4444); color: white; }
  .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(239,68,68,0.4); }
  .btn-secondary { background: #f3f4f6; color: #374151; }
  .btn-secondary:hover { background: #e5e7eb; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
  .log { background: #1f2937; color: #34d399; border-radius: 12px; padding: 16px; font-family: monospace; font-size: 13px; height: 220px; overflow-y: auto; margin: 16px 0; white-space: pre-wrap; display: none; }
  .log.show { display: block; }
  .status { padding: 12px 16px; border-radius: 12px; font-weight: 600; font-size: 14px; margin-bottom: 16px; display: none; }
  .status.show { display: block; }
  .status.ok { background: #d1fae5; color: #065f46; }
  .status.error { background: #fee2e2; color: #991b1b; }
  .status.info { background: #dbeafe; color: #1e40af; }
  input[type=file] { width: 100%; padding: 12px; border: 2px dashed #d1d5db; border-radius: 12px; margin-bottom: 12px; cursor: pointer; font-size: 14px; }
  .warning { background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; padding: 12px; font-size: 13px; color: #92400e; margin-bottom: 20px; }
</style>
</head>
<body>
<div class="card">
  <h1>üê¶ LikeBird</h1>
  <p class="sub">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±—ç–∫–∞–ø–∞ –≤ Firebase.<br>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.</p>
  
  <div class="warning">
    ‚ö†Ô∏è <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ Firebase. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã–±—Ä–∞–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–∞–π–ª –±—ç–∫–∞–ø–∞.
  </div>

  <div id="status" class="status"></div>

  <label><strong style="font-size:14px; color:#374151; display:block; margin-bottom:6px;">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –±—ç–∫–∞–ø–∞ (JSON)</strong>
    <input type="file" id="fileInput" accept=".json" />
  </label>

  <div id="preview" style="display:none; background:#f9fafb; border-radius:12px; padding:12px; margin-bottom:12px; font-size:13px; color:#374151;"></div>

  <button class="btn btn-primary" id="restoreBtn" onclick="startRestore()" disabled>
    üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ Firebase
  </button>
  <button class="btn btn-secondary" onclick="window.location.href='/'">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>

  <div id="log" class="log"></div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
import { getDatabase, ref, set } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyAoZOo5LYtUKYiFhntbr0O5LfCKQEHn3jo",
  authDomain: "likebird-928e2.firebaseapp.com",
  databaseURL: "https://likebird-928e2-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "likebird-928e2",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const SKIP_KEYS = new Set(['likebird-auth', 'likebird-sync-id', 'likebird-employee', '_version', '_exportDate', '_syncId']);

const ALLOWED_KEYS = new Set([
  'likebird-reports', 'likebird-expenses', 'likebird-stock', 'likebird-given',
  'likebird-salary-decisions', 'likebird-owncard', 'likebird-partners',
  'likebird-totalbirds', 'likebird-schedule', 'likebird-events', 'likebird-manuals',
  'likebird-salary-settings', 'likebird-admin-password', 'likebird-employees',
  'likebird-sales-plan', 'likebird-audit-log', 'likebird-custom-products',
  'likebird-locations', 'likebird-cost-prices', 'likebird-penalties',
  'likebird-bonuses', 'likebird-timeoff', 'likebird-ratings', 'likebird-chat',
  'likebird-stock-history', 'likebird-writeoffs', 'likebird-autoorder',
  'likebird-kpi', 'likebird-profiles', 'likebird-users', 'likebird-invite-codes',
  'likebird-custom-achievements', 'likebird-achievements-granted', 'likebird-shifts',
]);

let backupData = null;

document.getElementById('fileInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  try {
    const text = await file.text();
    backupData = JSON.parse(text);
    const keys = Object.keys(backupData).filter(k => !SKIP_KEYS.has(k) && ALLOWED_KEYS.has(k));
    const reports = backupData['likebird-reports'];
    document.getElementById('preview').style.display = 'block';
    document.getElementById('preview').innerHTML = `
      <strong>–ù–∞–π–¥–µ–Ω–æ –∫–ª—é—á–µ–π –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: ${keys.length}</strong><br>
      ${reports ? `üìã –û—Ç—á—ë—Ç–æ–≤: <strong>${Array.isArray(reports) ? reports.length : '?'}</strong><br>` : ''}
      –ö–ª—é—á–∏: ${keys.join(', ')}
    `;
    document.getElementById('restoreBtn').disabled = false;
    showStatus('–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.', 'info');
  } catch(err) {
    showStatus('–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. ' + err.message, 'error');
  }
});

window.startRestore = async function() {
  if (!backupData) return;
  const btn = document.getElementById('restoreBtn');
  btn.disabled = true;
  btn.textContent = '‚è≥ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º...';
  const log = document.getElementById('log');
  log.classList.add('show');
  log.textContent = '';

  const addLog = (msg) => { log.textContent += msg + '\n'; log.scrollTop = log.scrollHeight; };

  addLog('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ...');
  let ok = 0, skip = 0, errors = 0;

  for (const [key, value] of Object.entries(backupData)) {
    if (SKIP_KEYS.has(key)) { addLog(`‚è≠ –ü—Ä–æ–ø—É—â–µ–Ω (—Å–ª—É–∂–µ–±–Ω—ã–π): ${key}`); skip++; continue; }
    if (!ALLOWED_KEYS.has(key)) { addLog(`‚è≠ –ü—Ä–æ–ø—É—â–µ–Ω (–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π): ${key}`); skip++; continue; }
    try {
      await set(ref(db, `data/${key}`), value);
      const count = Array.isArray(value) ? value.length : (typeof value === 'object' ? Object.keys(value).length : 1);
      addLog(`‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${key} (${count} –∑–∞–ø–∏—Å–µ–π)`);
      ok++;
    } catch(err) {
      addLog(`‚ùå –û—à–∏–±–∫–∞: ${key} ‚Äî ${err.message}`);
      errors++;
    }
    await new Promise(r => setTimeout(r, 100)); // –Ω–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞
  }

  addLog(`\nüèÅ –ì–æ—Ç–æ–≤–æ! –£—Å–ø–µ—à–Ω–æ: ${ok}, –ü—Ä–æ–ø—É—â–µ–Ω–æ: ${skip}, –û—à–∏–±–æ–∫: ${errors}`);
  btn.textContent = errors === 0 ? '‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!' : `‚ö†Ô∏è –ó–∞–≤–µ—Ä—à–µ–Ω–æ —Å ${errors} –æ—à–∏–±–∫–∞–º–∏`;
  showStatus(errors === 0 ? `–£—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ ${ok} –∫–ª—é—á–µ–π! –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.` : `–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ ${ok}, –æ—à–∏–±–æ–∫: ${errors}`, errors === 0 ? 'ok' : 'error');
}

function showStatus(msg, type) {
  const el = document.getElementById('status');
  el.textContent = msg;
  el.className = `status show ${type}`;
}
</script>
</body>
</html>
